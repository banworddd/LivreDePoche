{% extends 'layout.html' %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
    <h1>{{ book.title }}</h1>
    <p><strong>Авторы:</strong>
        {% for author in book.authors.all %}
            {{ author.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </p>
    <p><strong>Жанры:</strong>
        {% for genre in book.genre.all %}
            {{ genre.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </p>
    <p><strong>Краткое описание:</strong> {{ book.summary }}</p>
    <p><strong>Описание:</strong> {{ book.description }}</p>

    <!-- Кнопки для добавления книги в списки отображаются только для аутентифицированных пользователей -->
    {% if user.is_authenticated %}
        <h3>Добавить в мой список</h3>
        <form method="POST">
    {% csrf_token %}
    {% if not is_read %}
        <button type="submit" name="action" value="read">Добавить в прочитанное</button>
    {% endif %}
    {% if not is_reading %}
        <button type="submit" name="action" value="reading">Добавить в читается сейчас</button>
    {% endif %}
    {% if not is_planned %}
        <button type="submit" name="action" value="planned">Добавить в планируется к прочтению</button>
    {% endif %}
</form>

        <!-- Форма для добавления отзыва, если книга уже прочитана -->
        {% if is_read %}
            <h3>Оставить отзыв</h3>
            <form method="POST" action="{% url 'add_review' book.id %}">
                {% csrf_token %}
                <label for="rating">Оценка (1-5):</label>
                <input type="number" id="rating" name="rating" min="1" max="5" required>

                <label for="review_text">Текст отзыва:</label>
                <textarea id="review_text" name="review_text" required></textarea>

                <button type="submit">Оставить отзыв</button>
            </form>
        {% endif %}
    {% else %}
        <!-- Сообщение для неаутентифицированных пользователей -->
        <p>Чтобы добавить книгу в свой список или оставить отзыв, пожалуйста, <a href="{% url 'login' %}">войдите</a> или <a href="{% url 'register' %}">зарегистрируйтесь</a>.</p>
    {% endif %}

    <!-- Отзывы пользователей -->
    <h2>Отзывы</h2>
    {% if reviews %}
        <ul>
            {% for review in reviews %}
                <li>
                    <p><strong>{{ review.user.username }}</strong> (оценка: {{ review.rating }})</p>
                    <p>{{ review.review_text }}</p>
                    <p><em>Дата отзыва: {{ review.review_date }}</em></p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Отзывов на эту книгу пока нет.</p>
    {% endif %}
{% endblock %}
