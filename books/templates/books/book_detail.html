{% extends 'layout.html' %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
<h2 id="book-title"></h2>
<p><strong>Автор:</strong> <span id="book-authors"></span></p>
<p><strong>Описание:</strong> <span id="book-description"></span></p>
<p><strong>Жанры:</strong> <span id="book-genres"></span></p>

<h3>Отзывы</h3>
<ul id="reviews-list">
    {% for review in reviews %}
    <li>
        <strong>{{ review.user.username }}</strong> - {{ review.rating }}⭐
        <p>{{ review.review_text }}</p>
    </li>
    {% empty %}
    <li>Нет отзывов для этой книги.</li>
    {% endfor %}
</ul>

{% if user.is_authenticated %}
<div id="reading-list-buttons">
    <h3>Добавить в список</h3>
    <button id="add-to-wishlist" data-status="planned">Добавить в список желаемого</button>
    <button id="add-to-reading" data-status="currently_reading">Добавить в список читаемого</button>
    <button id="add-to-completed" data-status="completed">Добавить в список прочитанного</button>
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    const bookId = "{{ book.id }}";

    // Функция для получения данных о книге через API
    function fetchBookDetails() {
        fetch(`/api/book/${bookId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                // Обновляем содержимое на странице
                document.getElementById('book-title').textContent = data.title;
                document.getElementById('book-description').textContent = data.description;

                const authorNames = data.authors.map(author => author.name).join(', ');
                document.getElementById('book-authors').textContent = authorNames;

                const genreNames = data.genre.map(genre => genre.name).join(', ');
                document.getElementById('book-genres').textContent = genreNames;
            })
            .catch(error => console.error('Ошибка:', error));
    }

    // Получаем данные о книге при загрузке страницы
    fetchBookDetails();

    {% if user.is_authenticated %}
    const buttons = document.querySelectorAll("button[data-status]");

    buttons.forEach(button => {
        button.addEventListener("click", function() {
            const status = this.getAttribute("data-status");

            fetch(`/api/reading_list/{{ user.username }}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    book: bookId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                } else {
                    console.log("Книга успешно добавлена в список:", data);
                }
            })
            .catch(error => console.error('Ошибка:', error));
        });
    });
    {% endif %}
});
</script>

{% endblock %}
